const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./StationDetailPopup-DTxX46d9.js","./index-D01RTJrl.js"])))=>i.map(i=>d[i]);
import{C as D,L as v,F as m,G as M,M as R,d as _,s as k,_ as I,D as C,f as A,g as E,h as P,i as V,j as $}from"./index-D01RTJrl.js";const b=30;function W(i,e=0,n=1){return{id:`train-${Date.now()}-${Math.random().toString(36).substr(2,5)}`,lineId:i,currentStationIdx:e,targetStationIdx:e+1,progress:0,direction:1,speed:n,currentSegment:null,totalLength:0,passengers:[],capacity:b}}function X(i,e,n){return{id:`p-${Date.now()}-${Math.random().toString(36).substr(2,5)}`,sourceStationId:i,destinationStationId:e,spawnTime:n,path:[],nextWaypointIndex:0,currentStationId:i}}function N(i,e,n,t){if(i===e)return[];const s=Y(n,t),o=[],a=new Set;for(o.push({stationId:i,path:[i]}),a.add(i);o.length>0;){const r=o.shift(),{stationId:h,path:l}=r;if(h===e)return l;const c=s.get(h);if(c)for(const u of c.connections)a.has(u.targetStationId)||(a.add(u.targetStationId),o.push({stationId:u.targetStationId,path:[...l,u.targetStationId]}))}return null}function Y(i,e){const n=new Map;for(const t of i)n.set(t.id,{stationId:t.id,connections:[]});for(const t of e)if(!(t.stationIds.length<2)){for(let s=0;s<t.stationIds.length-1;s++){const o=t.stationIds[s],a=t.stationIds[s+1],r=n.get(o),h=n.get(a);r&&h&&(r.connections.push({targetStationId:a,lineId:t.id}),h.connections.push({targetStationId:o,lineId:t.id}))}if(t.isLoop&&t.stationIds.length>2){const s=t.stationIds[t.stationIds.length-1],o=t.stationIds[0],a=n.get(s),r=n.get(o);a&&r&&(a.connections.push({targetStationId:o,lineId:t.id}),r.connections.push({targetStationId:s,lineId:t.id}))}}return n}const O=.5,B=new Map;function w(i,e){if(B.has(i.id))return B.get(i.id);let n=0,t=0;const s=[{x:i.vertexX-1,y:i.vertexY-1},{x:i.vertexX,y:i.vertexY-1},{x:i.vertexX-1,y:i.vertexY},{x:i.vertexX,y:i.vertexY}],o=new Set,a=[];for(const d of s)y(d.x,d.y,e)&&(a.push({...d,dist:0}),o.add(`${d.x},${d.y}`));const r=i.vertexX-2,h=i.vertexX+1,l=i.vertexY-2,c=i.vertexY+1;o.clear(),a.length=0;for(const d of s)d.x>=r&&d.x<=h&&d.y>=l&&d.y<=c&&y(d.x,d.y,e)&&(a.push({...d,dist:0}),o.add(`${d.x},${d.y}`));let u=0;for(;u<a.length;){const d=a[u++],g=e.squares[d.y][d.x];n+=g.homeDensity,t+=g.officeDensity;const S=[{x:d.x-1,y:d.y},{x:d.x+1,y:d.y},{x:d.x,y:d.y-1},{x:d.x,y:d.y+1}];for(const p of S)p.x>=r&&p.x<=h&&p.y>=l&&p.y<=c&&!o.has(`${p.x},${p.y}`)&&y(p.x,p.y,e)&&(o.add(`${p.x},${p.y}`),a.push({...p,dist:d.dist+1}))}const f={residential:n,office:t};return B.set(i.id,f),f}function y(i,e,n){return i<0||i>=n.width||e<0||e>=n.height?!1:n.squares[e][i].type==="LAND"}function z(i,e){i.stations.length>0&&B.size===0&&i.stations.forEach(l=>w(l,i.map));const t=new Date(i.simulationTime).getHours();let s=!1,o=!1,a=1;t>=6&&t<10?(s=!0,a=3):t>=16&&t<20?(o=!0,a=3):(t>=22||t<5)&&(a=.1);const r=new Map;let h=0;for(const l of i.stations){const c=w(l,i.map);let u=1;s?u+=c.office*2:o?u+=c.residential*2:u+=c.residential+c.office,r.set(l.id,u),h+=u}for(const l of i.stations){const c=w(l,i.map);let u=0;s?u=c.residential:o?u=c.office:u=(c.residential+c.office)*.5;const f=u/(1e4*25),d=O*a*f*e/3600;Math.random()<d&&F(l,i,r,h)}}function F(i,e,n,t){const s=n.get(i.id)||0,o=t-s;if(o<=0)return;let a=Math.random()*o,r="";for(const c of e.stations){if(c.id===i.id)continue;const u=n.get(c.id)||0;if(a-=u,a<=0){r=c.id;break}}if(!r&&e.stations.length>1){const c=e.stations.find(u=>u.id!==i.id);c&&(r=c.id)}if(!r)return;const h=N(i.id,r,e.stations,e.lines);if(!h||h.length===0)return;const l=X(i.id,r,e.simulationTime);l.path=h,l.nextWaypointIndex=1,e.passengers.push(l),i.passengers.push(l)}function G(i,e,n){const t=n.stationIds.indexOf(e);if(t===-1)return!1;const s=i.currentStationIdx;return i.direction===1?t>s:t<s}function q(i,e,n){for(const t of n){const s=t.stationIds.indexOf(i),o=t.stationIds.indexOf(e);if(s!==-1&&o!==-1&&Math.abs(s-o)===1)return t.id}return null}function H(i,e,n){const t=n.lines.find(o=>o.id===e.lineId);if(!t)return;e.passengers||(e.passengers=[]);const s=i.passengers.filter(o=>o.currentStationId===i.id&&!o.currentTrainId);for(const o of s){if(e.passengers.length>=b)break;if(U(o,e,t,n)){o.currentStationId=void 0,o.currentTrainId=e.id,e.passengers.push(o);const a=i.passengers.indexOf(o);a!==-1&&i.passengers.splice(a,1)}}}function U(i,e,n,t){const s=i.path[i.nextWaypointIndex];if(!s)return!1;const o=i.currentStationId;return!o||q(o,s,t.lines)!==n.id?!1:G(e,s,n)}function j(i,e,n){if(!e.passengers){e.passengers=[];return}const t=[];for(const s of e.passengers)s.path[s.nextWaypointIndex]===i.id&&t.push(s);for(const s of t){const o=e.passengers.indexOf(s);o!==-1&&e.passengers.splice(o,1),s.currentTrainId=void 0,i.id===s.destinationStationId?J(s,n):(s.currentStationId=i.id,s.nextWaypointIndex++,i.passengers.push(s))}}function J(i,e){const n=e.passengers.indexOf(i);n!==-1&&e.passengers.splice(n,1);for(const t of e.stations){const s=t.passengers.indexOf(i);s!==-1&&(t.passengers.splice(s,1),console.warn(`Cleaned up completed passenger ${i.id} from station ${t.id}`))}i.currentStationId=void 0,i.currentTrainId=void 0}function Z(i,e,n){j(e,i,n),H(e,i,n)}const K=300*1e3,Q=600*1e3,tt=1200*1e3,et=3600*1e3;class it extends D{static assetBundles=["main"];titleLabel;clockLabel;stopButton;speed1xButton;speed2xButton;speed4xButton;speed12xButton;mapRenderer;metroRenderer;mapContainer;mapBackground;gameState;isRunning=!1;currentSpeed="1x";lastUpdateTime=0;constructor(){super(),this.titleLabel=new v({text:"Metro Simulation",style:{fontSize:36,fill:16777215}}),this.addChild(this.titleLabel),this.clockLabel=new v({text:this.formatDateTime(new Date("2025-01-01T08:00:00")),style:{fontSize:24,fill:8965375,fontFamily:"monospace"}}),this.addChild(this.clockLabel),this.stopButton=new m({text:"Stop Simulation",width:160,height:50,fontSize:18,backgroundColor:15158332}),this.stopButton.onPress.connect(()=>this.stopSimulation()),this.addChild(this.stopButton),this.speed1xButton=new m({text:"1x",width:60,height:50,fontSize:18,backgroundColor:4886754}),this.speed1xButton.onPress.connect(()=>this.setSpeed("1x")),this.addChild(this.speed1xButton),this.speed2xButton=new m({text:"2x",width:60,height:50,fontSize:18,backgroundColor:5592405}),this.speed2xButton.onPress.connect(()=>this.setSpeed("2x")),this.addChild(this.speed2xButton),this.speed4xButton=new m({text:"4x",width:60,height:50,fontSize:18,backgroundColor:5592405}),this.speed4xButton.onPress.connect(()=>this.setSpeed("4x")),this.addChild(this.speed4xButton),this.speed12xButton=new m({text:"12x",width:60,height:50,fontSize:18,backgroundColor:5592405}),this.speed12xButton.onPress.connect(()=>this.setSpeed("12x")),this.addChild(this.speed12xButton),this.mapContainer=new D,this.addChild(this.mapContainer),this.mapBackground=new M,this.mapContainer.addChild(this.mapBackground),this.mapRenderer=new R,this.mapContainer.addChild(this.mapRenderer),this.metroRenderer=new _,this.mapContainer.addChild(this.metroRenderer)}formatDateTime(e){if(!e||isNaN(e.getTime())){const r=new Date("2025-01-01T08:00:00");return this.formatDateTime(r)}const n=e.getDate().toString().padStart(2,"0"),t=(e.getMonth()+1).toString().padStart(2,"0"),s=e.getFullYear(),o=e.getHours().toString().padStart(2,"0"),a=e.getMinutes().toString().padStart(2,"0");return`${n}/${t}/${s} ${o}:${a}`}setSpeed(e){this.currentSpeed=e,e==="1x"?(this.speed1xButton.alpha=1,this.speed1xButton.defaultView.tint=4886754,this.speed2xButton.alpha=.7,this.speed2xButton.defaultView.tint=8947848,this.speed4xButton.alpha=.7,this.speed4xButton.defaultView.tint=8947848,this.speed12xButton.alpha=.7,this.speed12xButton.defaultView.tint=8947848):e==="2x"?(this.speed1xButton.alpha=.7,this.speed1xButton.defaultView.tint=8947848,this.speed2xButton.alpha=1,this.speed2xButton.defaultView.tint=4886754,this.speed4xButton.alpha=.7,this.speed4xButton.defaultView.tint=8947848,this.speed12xButton.alpha=.7,this.speed12xButton.defaultView.tint=8947848):e==="4x"?(this.speed1xButton.alpha=.7,this.speed1xButton.defaultView.tint=8947848,this.speed2xButton.alpha=.7,this.speed2xButton.defaultView.tint=8947848,this.speed4xButton.alpha=1,this.speed4xButton.defaultView.tint=4886754,this.speed12xButton.alpha=.7,this.speed12xButton.defaultView.tint=8947848):e==="12x"&&(this.speed1xButton.alpha=.7,this.speed1xButton.defaultView.tint=8947848,this.speed2xButton.alpha=.7,this.speed2xButton.defaultView.tint=8947848,this.speed4xButton.alpha=.7,this.speed4xButton.defaultView.tint=8947848,this.speed12xButton.alpha=1,this.speed12xButton.defaultView.tint=4886754)}async stopSimulation(){this.isRunning=!1,k(this.gameState);const{MetroBuildingScreen:e}=await I(async()=>{const{MetroBuildingScreen:s}=await import("./index-D01RTJrl.js").then(o=>o.aG);return{MetroBuildingScreen:s}},[],import.meta.url),{engine:n}=await I(async()=>{const{engine:s}=await import("./index-D01RTJrl.js").then(o=>o.aF);return{engine:s}},[],import.meta.url);await n().navigation.showScreen(e);const t=n().navigation.currentScreen;t&&t.setGameState&&t.setGameState(this.gameState)}updateSimulation=e=>{if(!this.isRunning)return;const n=performance.now(),t=(n-this.lastUpdateTime)/1e3;this.lastUpdateTime=n;let s,o;switch(this.currentSpeed){case"1x":s=K,o=1;break;case"2x":s=Q,o=2;break;case"4x":s=tt,o=4;break;case"12x":s=et,o=12;break}const a=t*s;this.gameState.simulationTime+=a;const r=new Date(this.gameState.simulationTime);this.clockLabel.text=this.formatDateTime(r),z(this.gameState,t*s),this.updateTrains(t*o),this.updateMetroRenderer(!0)};startSimulation(){this.isRunning=!0,this.lastUpdateTime=performance.now(),this.initializeTrains(),this.setSpeed(this.currentSpeed)}initializeTrains(){for(const e of this.gameState.lines)if(!e.trains||e.trains.length===0){e.trains=[];const n=W(e.id,0,1);this.updateTrainPath(n,e),e.trains.push(n)}else for(const n of e.trains)n.passengers||(n.passengers=[]),n.currentSegment||this.updateTrainPath(n,e)}updateTrains(e){for(const n of this.gameState.lines)if(n.trains)for(const t of n.trains){if(!t.currentSegment&&(this.updateTrainPath(t,n),!t.currentSegment))continue;const o=t.speed*e/t.totalLength;if(t.progress+=o,t.progress>=1){t.currentStationIdx=t.targetStationIdx,t.progress=0;const a=n.stationIds[t.currentStationIdx],r=this.gameState.stations.find(h=>h.id===a);r&&Z(t,r,this.gameState),n.isLoop?t.direction===1?t.targetStationIdx=(t.currentStationIdx+1)%n.stationIds.length:t.targetStationIdx=(t.currentStationIdx-1+n.stationIds.length)%n.stationIds.length:t.direction===1?t.currentStationIdx>=n.stationIds.length-1?(t.direction=-1,t.targetStationIdx=t.currentStationIdx-1):t.targetStationIdx=t.currentStationIdx+1:t.currentStationIdx<=0?(t.direction=1,t.targetStationIdx=t.currentStationIdx+1):t.targetStationIdx=t.currentStationIdx-1,this.updateTrainPath(t,n)}}}updateTrainPath(e,n){const t=e.currentStationIdx,s=e.targetStationIdx,o=n.stationIds[t],a=n.stationIds[s],r=this.gameState.stations.find(x=>x.id===o),h=this.gameState.stations.find(x=>x.id===a);if(!r||!h)return;if(r.id===h.id){e.currentSegment={fromStation:r,toStation:h,entryAngle:C.EAST,exitAngle:C.EAST,waypoints:[{x:r.vertexX,y:r.vertexY,type:"STATION"}]},e.totalLength=0;return}const l=Math.min(t,s),c=Math.max(t,s),u=n.stationIds[l],f=n.stationIds[c],d=this.gameState.stations.find(x=>x.id===u),g=this.gameState.stations.find(x=>x.id===f);let S=null;if(c+1<n.stationIds.length){const x=n.stationIds[c+1],T=this.gameState.stations.find(L=>L.id===x);T&&(S=A(g,T))}const p=E(d,g,S);t>s&&p.waypoints.reverse(),e.currentSegment=p,e.totalLength=this.calculateSegmentLength(p)}calculateSegmentLength(e){let n=0;const t=e.waypoints;for(let s=0;s<t.length-1;s++){const o=t[s],a=t[s+1],r=a.x-o.x,h=a.y-o.y;n+=Math.sqrt(r*r+h*h)}return n}updateMetroRenderer(e=!1){e?this.metroRenderer.renderStationLabels(this.gameState.stations):(this.metroRenderer.renderStations(this.gameState.stations),this.metroRenderer.renderLines(this.gameState.lines,this.gameState.stations)),this.metroRenderer.renderTrains(this.gameState.lines,this.gameState.stations)}setGameState(e){this.gameState=e,(!this.gameState.simulationTime||isNaN(this.gameState.simulationTime))&&(this.gameState.simulationTime=new Date("2025-01-01T08:00:00").getTime()),this.mapRenderer.renderMap(e.map),this.drawMapBackground(),this.updateMetroRenderer(!1),this.metroRenderer.onStationClick=t=>{this.showStationDetails(t)};const n=new Date(this.gameState.simulationTime);this.clockLabel.text=this.formatDateTime(n)}drawMapBackground(){const e=this.gameState.map.width*P,n=this.gameState.map.height*P;this.mapBackground.clear(),this.mapBackground.rect(0,0,e,n),this.mapBackground.stroke({width:2,color:4473924})}async showStationDetails(e){const{StationDetailPopup:n,setStationForPopup:t}=await I(async()=>{const{StationDetailPopup:o,setStationForPopup:a}=await import("./StationDetailPopup-DTxX46d9.js");return{StationDetailPopup:o,setStationForPopup:a}},__vite__mapDeps([0,1]),import.meta.url),{engine:s}=await I(async()=>{const{engine:o}=await import("./index-D01RTJrl.js").then(a=>a.aF);return{engine:o}},[],import.meta.url);t(e,this.gameState.stations),s().navigation.presentPopup(n)}resize(e,n){const t=e*.5;this.titleLabel.x=150,this.titleLabel.y=30,this.clockLabel.x=e-250,this.clockLabel.y=35;const s=n-80;this.stopButton.x=t-280,this.stopButton.y=s,this.speed1xButton.x=t+100,this.speed1xButton.y=s,this.speed2xButton.x=t+170,this.speed2xButton.y=s,this.speed4xButton.x=t+240,this.speed4xButton.y=s,this.speed12xButton.x=t+310,this.speed12xButton.y=s;const o=this.mapRenderer.getMapWidth(),a=this.mapRenderer.getMapHeight(),r=90,h=n-r-120,c=(e-40)/o,u=h/a,f=Math.min(1,c,u);this.mapContainer.scale.set(f),this.mapContainer.x=t-o*f/2,this.mapContainer.y=r}async show(){const e=[this.titleLabel,this.clockLabel,this.stopButton,this.speed1xButton,this.speed2xButton,this.speed4xButton,this.speed12xButton,this.mapContainer];for(const n of e)n.alpha=0;await V(e,{alpha:[0,1]},{duration:.3}).finished}update(){this.updateSimulation($.shared)}onDestroy(){this.isRunning=!1}}export{it as MetroSimulationScreen};
