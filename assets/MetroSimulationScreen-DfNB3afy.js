const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./StationDetailPopup-BOlaulRT.js","./index-DupuVaxC.js"])))=>i.map(i=>d[i]);
import{B as A,d as v,f as k,g as O,h as V,D as P,i as N,j as $,k as b,l as B,C,L as _,m as W,F as I,G as X,P as F,n as Y,o as G,p as z,_ as S,s as q,q as E,r as U,t as H,u as Q}from"./index-DupuVaxC.js";function j(n,e,i){return{id:`p-${Date.now()}-${Math.random().toString(36).substr(2,5)}`,sourceStationId:n,destinationStationId:e,spawnTime:i,path:[],nextWaypointIndex:0,currentStationId:n}}function J(n,e,i,t){if(n===e)return[];const s=Z(i,t),o=[],a=new Set;for(o.push({stationId:n,path:[n]}),a.add(n);o.length>0;){const r=o.shift(),{stationId:u,path:l}=r;if(u===e)return l;const h=s.get(u);if(h)for(const c of h.connections)a.has(c.targetStationId)||(a.add(c.targetStationId),o.push({stationId:c.targetStationId,path:[...l,c.targetStationId]}))}return null}function Z(n,e){const i=new Map;for(const t of n)i.set(t.id,{stationId:t.id,connections:[]});for(const t of e)if(!(t.stationIds.length<2)){for(let s=0;s<t.stationIds.length-1;s++){const o=t.stationIds[s],a=t.stationIds[s+1],r=i.get(o),u=i.get(a);r&&u&&(r.connections.push({targetStationId:a,lineId:t.id}),u.connections.push({targetStationId:o,lineId:t.id}))}if(t.isLoop&&t.stationIds.length>2){const s=t.stationIds[t.stationIds.length-1],o=t.stationIds[0],a=i.get(s),r=i.get(o);a&&r&&(a.connections.push({targetStationId:o,lineId:t.id}),r.connections.push({targetStationId:s,lineId:t.id}))}}return i}const y=new Map;function D(n,e){if(y.has(n.id))return y.get(n.id);let i=0,t=0;const s=[{x:n.vertexX-1,y:n.vertexY-1},{x:n.vertexX,y:n.vertexY-1},{x:n.vertexX-1,y:n.vertexY},{x:n.vertexX,y:n.vertexY}],o=new Set,a=[];for(const d of s)R(d.x,d.y,e)&&(a.push({...d,dist:0}),o.add(`${d.x},${d.y}`));const r=n.vertexX-2,u=n.vertexX+1,l=n.vertexY-2,h=n.vertexY+1;o.clear(),a.length=0;for(const d of s)d.x>=r&&d.x<=u&&d.y>=l&&d.y<=h&&R(d.x,d.y,e)&&(a.push({...d,dist:0}),o.add(`${d.x},${d.y}`));let c=0;for(;c<a.length;){const d=a[c++],x=e.squares[d.y][d.x];i+=x.homeDensity,t+=x.officeDensity;const m=[{x:d.x-1,y:d.y},{x:d.x+1,y:d.y},{x:d.x,y:d.y-1},{x:d.x,y:d.y+1}];for(const p of m)p.x>=r&&p.x<=u&&p.y>=l&&p.y<=h&&!o.has(`${p.x},${p.y}`)&&R(p.x,p.y,e)&&(o.add(`${p.x},${p.y}`),a.push({...p,dist:d.dist+1}))}const f={residential:i,office:t};return y.set(n.id,f),f}function R(n,e,i){return n<0||n>=i.width||e<0||e>=i.height?!1:i.squares[e][n].type==="LAND"}function K(n,e){n.stations.length>0&&y.size===0&&n.stations.forEach(l=>D(l,n.map));const t=new Date(n.simulationTime).getHours();let s=!1,o=!1,a=1;t>=6&&t<10?(s=!0,a=3):t>=16&&t<20?(o=!0,a=3):(t>=22||t<5)&&(a=.1);const r=new Map;let u=0;for(const l of n.stations){const h=D(l,n.map);let c=1;s?c+=h.office*2:o?c+=h.residential*2:c+=h.residential+h.office,r.set(l.id,c),u+=c}for(const l of n.stations){const h=D(l,n.map);let c=0;s?c=h.residential:o?c=h.office:c=(h.residential+h.office)*.5;const f=c/(1e4*25),d=A*a*f*e/3600;Math.random()<d&&tt(l,n,r,u)}}function tt(n,e,i,t){const s=i.get(n.id)||0,o=t-s;if(o<=0)return;let a=Math.random()*o,r="";for(const h of e.stations){if(h.id===n.id)continue;const c=i.get(h.id)||0;if(a-=c,a<=0){r=h.id;break}}if(!r&&e.stations.length>1){const h=e.stations.find(c=>c.id!==n.id);h&&(r=h.id)}if(!r)return;const u=J(n.id,r,e.stations,e.lines);if(!u||u.length===0)return;const l=j(n.id,r,e.simulationTime);l.path=u,l.nextWaypointIndex=1,e.passengers.push(l),n.passengers.push(l)}function et(n,e=0){return{id:`train-${Date.now()}-${Math.random().toString(36).substr(2,5)}`,lineId:n,state:"MOVING",dwellRemaining:0,currentStationIdx:e,targetStationIdx:e+1,progress:0,direction:1,currentSegment:null,totalLength:0,passengers:[],capacity:v}}function nt(n,e,i){const t=i.stationIds.indexOf(e);if(t===-1)return!1;const s=n.currentStationIdx;return n.direction===1?t>s:t<s}function it(n,e,i){for(const t of i){const s=t.stationIds.indexOf(n),o=t.stationIds.indexOf(e);if(s!==-1&&o!==-1)return t.id}return null}function st(n,e,i){const t=i.lines.find(o=>o.id===e.lineId);if(!t)return;e.passengers||(e.passengers=[]);const s=n.passengers.filter(o=>o.currentStationId===n.id&&!o.currentTrainId);for(const o of s){if(e.passengers.length>=v)break;if(ot(o,e,t,i)){o.currentStationId=void 0,o.currentTrainId=e.id,e.passengers.push(o);const a=n.passengers.indexOf(o);a!==-1&&n.passengers.splice(a,1)}}}function ot(n,e,i,t){const s=n.path[n.nextWaypointIndex];if(!s)return!1;const o=n.currentStationId;return!o||it(o,s,t.lines)!==i.id?!1:nt(e,s,i)}function at(n,e,i){if(!e.passengers){e.passengers=[];return}const t=[];for(const s of e.passengers)s.path[s.nextWaypointIndex]===n.id&&t.push(s);for(const s of t){const o=e.passengers.indexOf(s);o!==-1&&e.passengers.splice(o,1),s.currentTrainId=void 0,n.id===s.destinationStationId?rt(s,i):(s.currentStationId=n.id,s.nextWaypointIndex++,n.passengers.push(s))}}function rt(n,e){const i=e.passengers.indexOf(n);i!==-1&&e.passengers.splice(i,1);for(const t of e.stations){const s=t.passengers.indexOf(n);s!==-1&&(t.passengers.splice(s,1),console.warn(`Cleaned up completed passenger ${n.id} from station ${t.id}`))}n.currentStationId=void 0,n.currentTrainId=void 0,k(e)}function dt(n,e,i){at(e,n,i),st(e,n,i)}function ct(n){for(const e of n.lines)if(!e.trains||e.trains.length===0){e.trains=[];const i=et(e.id,0);T(i,e,n),e.trains.push(i)}else for(const i of e.trains)i.passengers||(i.passengers=[]),i.currentSegment||T(i,e,n)}function lt(n,e){for(const i of n.lines)if(i.trains){for(const t of i.trains)if(t.state||(t.state="MOVING",t.dwellRemaining=0),!(!t.currentSegment&&(T(t,i,n),!t.currentSegment))){if(t.state==="STOPPED"){const s=b*e;if(t.dwellRemaining-=s,t.dwellRemaining<=0)t.state="MOVING",t.dwellRemaining=0;else continue}if(t.state==="MOVING"){const s=t.totalLength,o=t.progress*s,a=s-o;let r=1;if(o<B){const c=Math.max(.1,o/B);r=Math.min(r,c)}if(a<B){const c=Math.max(.1,a/B);r=Math.min(r,c)}const l=b*r*e;O(n,l);const h=t.totalLength>0?l/t.totalLength:1;if(t.progress+=h,t.progress>=1){t.currentStationIdx=t.targetStationIdx,t.progress=0,t.state="STOPPED",t.dwellRemaining=V,i.isLoop?t.direction===1?t.targetStationIdx=(t.currentStationIdx+1)%i.stationIds.length:t.targetStationIdx=(t.currentStationIdx-1+i.stationIds.length)%i.stationIds.length:t.direction===1?t.currentStationIdx>=i.stationIds.length-1?(t.direction=-1,t.targetStationIdx=t.currentStationIdx-1):t.targetStationIdx=t.currentStationIdx+1:t.currentStationIdx<=0?(t.direction=1,t.targetStationIdx=t.currentStationIdx+1):t.targetStationIdx=t.currentStationIdx-1;const c=i.stationIds[t.currentStationIdx],f=n.stations.find(d=>d.id===c);f&&dt(t,f,n),T(t,i,n)}}}}}function T(n,e,i){const t=n.currentStationIdx,s=n.targetStationIdx,o=e.stationIds[t],a=e.stationIds[s],r=i.stations.find(g=>g.id===o),u=i.stations.find(g=>g.id===a);if(!r||!u)return;if(r.id===u.id){n.currentSegment={fromStation:r,toStation:u,entryAngle:P.EAST,exitAngle:P.EAST,waypoints:[{x:r.vertexX,y:r.vertexY,type:"STATION"}]},n.totalLength=0;return}const l=Math.min(t,s),h=Math.max(t,s),c=e.stationIds[l],f=e.stationIds[h],d=i.stations.find(g=>g.id===c),x=i.stations.find(g=>g.id===f);let m=null;if(h+1<e.stationIds.length){const g=e.stationIds[h+1],M=i.stations.find(w=>w.id===g);M&&(m=N(x,M))}const p=$(d,x,m);t>s&&p.waypoints.reverse(),n.currentSegment=p,n.totalLength=ht(p)}function ht(n){let e=0;const i=n.waypoints;for(let t=0;t<i.length-1;t++){const s=i[t],o=i[t+1],a=o.x-s.x,r=o.y-s.y;e+=Math.sqrt(a*a+r*r)}return e}const L=Q,ut=L*2,pt=L*4;class gt extends C{static assetBundles=["main"];titleLabel;moneyLabel;clockLabel;stopButton;pauseToggleButton;speed1xButton;speed2xButton;speed4xButton;mapRenderer;metroRenderer;mapContainer;mapBackground;footer;gameState;isRunning=!1;isPaused=!1;currentSpeed="1x";lastUpdateTime=0;constructor(){super(),this.titleLabel=new _({text:"Metro Simulation",style:{fontSize:36,fill:16777215}}),this.addChild(this.titleLabel),this.moneyLabel=new _({text:"$10000",style:{fontSize:24,fill:65280,fontFamily:"monospace",fontWeight:"bold"}}),this.addChild(this.moneyLabel),this.clockLabel=new _({text:this.formatDateTime(new Date(W)),style:{fontSize:24,fill:8965375,fontFamily:"monospace"}}),this.addChild(this.clockLabel),this.stopButton=new I({text:"Stop Simulation",width:160,height:50,fontSize:18,backgroundColor:15158332}),this.stopButton.onPress.connect(()=>this.stopSimulation()),this.addChild(this.stopButton),this.pauseToggleButton=new I({text:"⏸",width:60,height:50,fontSize:24,backgroundColor:15965202}),this.pauseToggleButton.onPress.connect(()=>this.togglePause()),this.addChild(this.pauseToggleButton),this.speed1xButton=new I({text:"1x",width:60,height:50,fontSize:18,backgroundColor:4886754}),this.speed1xButton.onPress.connect(()=>this.setSpeed("1x")),this.addChild(this.speed1xButton),this.speed2xButton=new I({text:"2x",width:60,height:50,fontSize:18,backgroundColor:5592405}),this.speed2xButton.onPress.connect(()=>this.setSpeed("2x")),this.addChild(this.speed2xButton),this.speed4xButton=new I({text:"4x",width:60,height:50,fontSize:18,backgroundColor:5592405}),this.speed4xButton.onPress.connect(()=>this.setSpeed("4x")),this.addChild(this.speed4xButton),this.mapContainer=new C,this.addChild(this.mapContainer),this.mapBackground=new X,this.mapContainer.addChild(this.mapBackground),this.mapRenderer=new F,this.mapContainer.addChild(this.mapRenderer),this.metroRenderer=new Y,this.mapContainer.addChild(this.metroRenderer),this.footer=new G,this.addChild(this.footer)}formatDateTime(e){if(!e||isNaN(e.getTime())){const r=new Date("2025-01-01T08:00:00");return this.formatDateTime(r)}const i=e.getDate().toString().padStart(2,"0"),t=(e.getMonth()+1).toString().padStart(2,"0"),s=e.getFullYear(),o=e.getHours().toString().padStart(2,"0"),a=e.getMinutes().toString().padStart(2,"0");return`${i}/${t}/${s} ${o}:${a}`}updateMoneyDisplay(){const e=this.gameState?.money??0,{text:i,color:t}=z(e);this.moneyLabel.text=i,this.moneyLabel.style.fill=t}setSpeed(e){this.currentSpeed=e,e==="1x"?(this.speed1xButton.alpha=1,this.speed1xButton.defaultView.tint=4886754,this.speed2xButton.alpha=.7,this.speed2xButton.defaultView.tint=8947848,this.speed4xButton.alpha=.7,this.speed4xButton.defaultView.tint=8947848):e==="2x"?(this.speed1xButton.alpha=.7,this.speed1xButton.defaultView.tint=8947848,this.speed2xButton.alpha=1,this.speed2xButton.defaultView.tint=4886754,this.speed4xButton.alpha=.7,this.speed4xButton.defaultView.tint=8947848):e==="4x"&&(this.speed1xButton.alpha=.7,this.speed1xButton.defaultView.tint=8947848,this.speed2xButton.alpha=.7,this.speed2xButton.defaultView.tint=8947848,this.speed4xButton.alpha=1,this.speed4xButton.defaultView.tint=4886754)}async stopSimulation(){if(this.isRunning=!1,!this.gameState){console.warn("MetroSimulationScreen: gameState is undefined during stopSimulation");const{MetroBuildingScreen:s}=await S(async()=>{const{MetroBuildingScreen:a}=await import("./index-DupuVaxC.js").then(r=>r.aR);return{MetroBuildingScreen:a}},[],import.meta.url),{engine:o}=await S(async()=>{const{engine:a}=await import("./index-DupuVaxC.js").then(r=>r.aQ);return{engine:a}},[],import.meta.url);await o().navigation.showScreen(s);return}q(this.gameState);const{MetroBuildingScreen:e}=await S(async()=>{const{MetroBuildingScreen:s}=await import("./index-DupuVaxC.js").then(o=>o.aR);return{MetroBuildingScreen:s}},[],import.meta.url),{engine:i}=await S(async()=>{const{engine:s}=await import("./index-DupuVaxC.js").then(o=>o.aQ);return{engine:s}},[],import.meta.url);await i().navigation.showScreen(e);const t=i().navigation.currentScreen;t&&t.setGameState&&t.setGameState(this.gameState)}togglePause(){this.isPaused=!this.isPaused,this.isPaused?(this.pauseToggleButton.text="▶",this.pauseToggleButton.defaultView.tint=2600544):(this.pauseToggleButton.text="⏸",this.pauseToggleButton.defaultView.tint=15965202)}updateSimulation=e=>{if(!this.isRunning)return;const i=performance.now();if(this.isPaused){this.lastUpdateTime=i;return}const t=(i-this.lastUpdateTime)/1e3;this.lastUpdateTime=i;let s,o;switch(this.currentSpeed){case"1x":s=L,o=1;break;case"2x":s=ut,o=2;break;case"4x":s=pt,o=4;break;default:s=L,o=1}const a=t*s;this.gameState.simulationTime+=a;const r=new Date(this.gameState.simulationTime);this.clockLabel.text=this.formatDateTime(r),this.updateMoneyDisplay(),K(this.gameState,t*s),lt(this.gameState,t*o),this.updateMetroRenderer(!0)};startSimulation(){this.isRunning=!0,this.isPaused=!1,this.pauseToggleButton.text="⏸",this.pauseToggleButton.defaultView.tint=15965202,this.lastUpdateTime=performance.now(),ct(this.gameState),this.setSpeed(this.currentSpeed)}updateMetroRenderer(e=!1){e?this.metroRenderer.renderStationLabels(this.gameState.stations):(this.metroRenderer.renderStations(this.gameState.stations),this.metroRenderer.renderLines(this.gameState.lines,this.gameState.stations)),this.metroRenderer.renderTrains(this.gameState.lines,this.gameState.stations)}setGameState(e){this.gameState=e,(!this.gameState.simulationTime||isNaN(this.gameState.simulationTime))&&(this.gameState.simulationTime=new Date("2025-01-01T08:00:00").getTime()),this.mapRenderer.renderMap(e.map),this.drawMapBackground(),this.updateMetroRenderer(!1),this.metroRenderer.onStationClick=t=>{this.showStationDetails(t)};const i=new Date(this.gameState.simulationTime);this.clockLabel.text=this.formatDateTime(i),this.updateMoneyDisplay()}drawMapBackground(){const e=this.gameState.map.width*E,i=this.gameState.map.height*E;this.mapBackground.clear(),this.mapBackground.rect(0,0,e,i),this.mapBackground.stroke({width:2,color:4473924})}async showStationDetails(e){const{StationDetailPopup:i,setStationForPopup:t}=await S(async()=>{const{StationDetailPopup:o,setStationForPopup:a}=await import("./StationDetailPopup-BOlaulRT.js");return{StationDetailPopup:o,setStationForPopup:a}},__vite__mapDeps([0,1]),import.meta.url),{engine:s}=await S(async()=>{const{engine:o}=await import("./index-DupuVaxC.js").then(a=>a.aQ);return{engine:o}},[],import.meta.url);t(e,this.gameState.stations),s().navigation.presentPopup(i)}resize(e,i){const t=e*.5,s=30;this.titleLabel.anchor.set(0,.5),this.titleLabel.x=20,this.titleLabel.y=s,this.clockLabel.anchor.set(1,.5),this.clockLabel.x=e-20,this.clockLabel.y=s,this.moneyLabel.anchor.set(1,.5);const o=this.clockLabel.x-this.clockLabel.width,a=20;this.moneyLabel.x=o-a,this.moneyLabel.y=s;const r=80;this.stopButton.x=20+this.stopButton.width/2,this.stopButton.y=r;const u=10;let l=e-20-this.speed4xButton.width/2;this.speed4xButton.x=l,this.speed4xButton.y=r,l-=this.speed4xButton.width/2+u+this.speed2xButton.width/2,this.speed2xButton.x=l,this.speed2xButton.y=r,l-=this.speed2xButton.width/2+u+this.speed1xButton.width/2,this.speed1xButton.x=l,this.speed1xButton.y=r,l-=this.speed1xButton.width/2+u+this.pauseToggleButton.width/2,this.pauseToggleButton.x=l,this.pauseToggleButton.y=r;const h=120,c=10,f=this.mapRenderer.getMapWidth(),d=this.mapRenderer.getMapHeight(),x=e-40,m=i-h-c,p=x/f,g=m/d,w=Math.min(3,p,g);this.mapContainer.scale.set(w),this.mapContainer.x=t-f*w/2,this.mapContainer.y=h,this.footer.resize(e,i)}async show(){const e=[this.titleLabel,this.moneyLabel,this.clockLabel,this.stopButton,this.pauseToggleButton,this.speed1xButton,this.speed2xButton,this.speed4xButton,this.mapContainer];for(const i of e)i.alpha=0;await U(e,{alpha:1},{duration:.4,ease:"easeOut"})}update(){this.updateSimulation(H.shared)}onDestroy(){this.isRunning=!1}}export{gt as MetroSimulationScreen};
