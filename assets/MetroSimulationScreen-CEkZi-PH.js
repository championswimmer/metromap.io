import{C as I,L as D,F as g,G as k,M as v,a as R,s as P,_ as b,D as C,c as E,b as _,T as M,d as V,e as A}from"./index-rqELCKNy.js";function $(n,t=0,i=1){return{id:`train-${Date.now()}-${Math.random().toString(36).substr(2,5)}`,lineId:n,currentStationIdx:t,targetStationIdx:t+1,progress:0,direction:1,speed:i,currentSegment:null,totalLength:0}}function X(n,t,i){return{id:`p-${Date.now()}-${Math.random().toString(36).substr(2,5)}`,sourceStationId:n,destinationStationId:t,spawnTime:i}}const Y=1,B=new Map;function w(n,t){if(B.has(n.id))return B.get(n.id);let i=0,e=0;const s=[{x:n.vertexX-1,y:n.vertexY-1},{x:n.vertexX,y:n.vertexY-1},{x:n.vertexX-1,y:n.vertexY},{x:n.vertexX,y:n.vertexY}],a=new Set,d=[];for(const o of s)y(o.x,o.y,t)&&(d.push({...o,dist:0}),a.add(`${o.x},${o.y}`));const r=n.vertexX-2,l=n.vertexX+1,c=n.vertexY-2,h=n.vertexY+1;a.clear(),d.length=0;for(const o of s)o.x>=r&&o.x<=l&&o.y>=c&&o.y<=h&&y(o.x,o.y,t)&&(d.push({...o,dist:0}),a.add(`${o.x},${o.y}`));let u=0;for(;u<d.length;){const o=d[u++],f=t.squares[o.y][o.x];i+=f.homeDensity,e+=f.officeDensity;const S=[{x:o.x-1,y:o.y},{x:o.x+1,y:o.y},{x:o.x,y:o.y-1},{x:o.x,y:o.y+1}];for(const p of S)p.x>=r&&p.x<=l&&p.y>=c&&p.y<=h&&!a.has(`${p.x},${p.y}`)&&y(p.x,p.y,t)&&(a.add(`${p.x},${p.y}`),d.push({...p,dist:o.dist+1}))}const x={residential:i,office:e};return B.set(n.id,x),x}function y(n,t,i){return n<0||n>=i.width||t<0||t>=i.height?!1:i.squares[t][n].type==="LAND"}function z(n,t){n.stations.length>0&&B.size===0&&n.stations.forEach(c=>w(c,n.map));const e=new Date(n.simulationTime).getHours();let s=!1,a=!1,d=1;e>=6&&e<10?(s=!0,d=3):e>=16&&e<20?(a=!0,d=3):(e>=22||e<5)&&(d=.1);const r=new Map;let l=0;for(const c of n.stations){const h=w(c,n.map);let u=1;s?u+=h.office*2:a?u+=h.residential*2:u+=h.residential+h.office,r.set(c.id,u),l+=u}for(const c of n.stations){const h=w(c,n.map);let u=0;s?u=h.residential:a?u=h.office:u=(h.residential+h.office)*.5;const x=u/(1e4*25),o=Y*d*x*t/3600;Math.random()<o&&N(c,n,r,l)}}function N(n,t,i,e){const s=i.get(n.id)||0,a=e-s;if(a<=0)return;let d=Math.random()*a,r="";for(const c of t.stations){if(c.id===n.id)continue;const h=i.get(c.id)||0;if(d-=h,d<=0){r=c.id;break}}if(!r&&t.stations.length>1){const c=t.stations.find(h=>h.id!==n.id);c&&(r=c.id)}if(!r)return;const l=X(n.id,r,t.simulationTime);t.passengers.push(l),n.passengers.push(l)}const W=300*1e3,F=600*1e3,G=1200*1e3,H=3600*1e3;class O extends I{static assetBundles=["main"];titleLabel;clockLabel;stopButton;speed1xButton;speed2xButton;speed4xButton;speed12xButton;mapRenderer;metroRenderer;mapContainer;mapBackground;gameState;isRunning=!1;currentSpeed="1x";lastUpdateTime=0;constructor(){super(),this.titleLabel=new D({text:"Metro Simulation",style:{fontSize:36,fill:16777215}}),this.addChild(this.titleLabel),this.clockLabel=new D({text:this.formatDateTime(new Date("2025-01-01T08:00:00")),style:{fontSize:24,fill:8965375,fontFamily:"monospace"}}),this.addChild(this.clockLabel),this.stopButton=new g({text:"Stop Simulation",width:160,height:50,fontSize:18,backgroundColor:15158332}),this.stopButton.onPress.connect(()=>this.stopSimulation()),this.addChild(this.stopButton),this.speed1xButton=new g({text:"1x",width:60,height:50,fontSize:18,backgroundColor:4886754}),this.speed1xButton.onPress.connect(()=>this.setSpeed("1x")),this.addChild(this.speed1xButton),this.speed2xButton=new g({text:"2x",width:60,height:50,fontSize:18,backgroundColor:5592405}),this.speed2xButton.onPress.connect(()=>this.setSpeed("2x")),this.addChild(this.speed2xButton),this.speed4xButton=new g({text:"4x",width:60,height:50,fontSize:18,backgroundColor:5592405}),this.speed4xButton.onPress.connect(()=>this.setSpeed("4x")),this.addChild(this.speed4xButton),this.speed12xButton=new g({text:"12x",width:60,height:50,fontSize:18,backgroundColor:5592405}),this.speed12xButton.onPress.connect(()=>this.setSpeed("12x")),this.addChild(this.speed12xButton),this.mapContainer=new I,this.addChild(this.mapContainer),this.mapBackground=new k,this.mapContainer.addChild(this.mapBackground),this.mapRenderer=new v,this.mapContainer.addChild(this.mapRenderer),this.metroRenderer=new R,this.mapContainer.addChild(this.metroRenderer)}formatDateTime(t){if(!t||isNaN(t.getTime())){const r=new Date("2025-01-01T08:00:00");return this.formatDateTime(r)}const i=t.getDate().toString().padStart(2,"0"),e=(t.getMonth()+1).toString().padStart(2,"0"),s=t.getFullYear(),a=t.getHours().toString().padStart(2,"0"),d=t.getMinutes().toString().padStart(2,"0");return`${i}/${e}/${s} ${a}:${d}`}setSpeed(t){this.currentSpeed=t,t==="1x"?(this.speed1xButton.alpha=1,this.speed1xButton.defaultView.tint=4886754,this.speed2xButton.alpha=.7,this.speed2xButton.defaultView.tint=8947848,this.speed4xButton.alpha=.7,this.speed4xButton.defaultView.tint=8947848,this.speed12xButton.alpha=.7,this.speed12xButton.defaultView.tint=8947848):t==="2x"?(this.speed1xButton.alpha=.7,this.speed1xButton.defaultView.tint=8947848,this.speed2xButton.alpha=1,this.speed2xButton.defaultView.tint=4886754,this.speed4xButton.alpha=.7,this.speed4xButton.defaultView.tint=8947848,this.speed12xButton.alpha=.7,this.speed12xButton.defaultView.tint=8947848):t==="4x"?(this.speed1xButton.alpha=.7,this.speed1xButton.defaultView.tint=8947848,this.speed2xButton.alpha=.7,this.speed2xButton.defaultView.tint=8947848,this.speed4xButton.alpha=1,this.speed4xButton.defaultView.tint=4886754,this.speed12xButton.alpha=.7,this.speed12xButton.defaultView.tint=8947848):t==="12x"&&(this.speed1xButton.alpha=.7,this.speed1xButton.defaultView.tint=8947848,this.speed2xButton.alpha=.7,this.speed2xButton.defaultView.tint=8947848,this.speed4xButton.alpha=.7,this.speed4xButton.defaultView.tint=8947848,this.speed12xButton.alpha=1,this.speed12xButton.defaultView.tint=4886754)}async stopSimulation(){this.isRunning=!1,P(this.gameState);const{MetroBuildingScreen:t}=await b(async()=>{const{MetroBuildingScreen:s}=await import("./index-rqELCKNy.js").then(a=>a.aE);return{MetroBuildingScreen:s}},[],import.meta.url),{engine:i}=await b(async()=>{const{engine:s}=await import("./index-rqELCKNy.js").then(a=>a.aD);return{engine:s}},[],import.meta.url);await i().navigation.showScreen(t);const e=i().navigation.currentScreen;e&&e.setGameState&&e.setGameState(this.gameState)}updateSimulation=t=>{if(!this.isRunning)return;const i=performance.now(),e=(i-this.lastUpdateTime)/1e3;this.lastUpdateTime=i;let s,a;switch(this.currentSpeed){case"1x":s=W,a=1;break;case"2x":s=F,a=2;break;case"4x":s=G,a=4;break;case"12x":s=H,a=12;break}const d=e*s;this.gameState.simulationTime+=d;const r=new Date(this.gameState.simulationTime);this.clockLabel.text=this.formatDateTime(r),z(this.gameState,e*s),this.updateTrains(e*a),this.updateMetroRenderer(!0)};startSimulation(){this.isRunning=!0,this.lastUpdateTime=performance.now(),this.initializeTrains(),this.setSpeed(this.currentSpeed)}initializeTrains(){for(const t of this.gameState.lines)if(!t.trains||t.trains.length===0){t.trains=[];const i=$(t.id,0,1);this.updateTrainPath(i,t),t.trains.push(i)}else for(const i of t.trains)i.currentSegment||this.updateTrainPath(i,t)}updateTrains(t){for(const i of this.gameState.lines)if(i.trains)for(const e of i.trains){if(!e.currentSegment&&(this.updateTrainPath(e,i),!e.currentSegment))continue;const a=e.speed*t/e.totalLength;e.progress+=a,e.progress>=1&&(e.currentStationIdx=e.targetStationIdx,e.progress=0,i.isLoop?e.direction===1?e.targetStationIdx=(e.currentStationIdx+1)%i.stationIds.length:e.targetStationIdx=(e.currentStationIdx-1+i.stationIds.length)%i.stationIds.length:e.direction===1?e.currentStationIdx>=i.stationIds.length-1?(e.direction=-1,e.targetStationIdx=e.currentStationIdx-1):e.targetStationIdx=e.currentStationIdx+1:e.currentStationIdx<=0?(e.direction=1,e.targetStationIdx=e.currentStationIdx+1):e.targetStationIdx=e.currentStationIdx-1,this.updateTrainPath(e,i))}}updateTrainPath(t,i){const e=t.currentStationIdx,s=t.targetStationIdx,a=i.stationIds[e],d=i.stationIds[s],r=this.gameState.stations.find(m=>m.id===a),l=this.gameState.stations.find(m=>m.id===d);if(!r||!l)return;if(r.id===l.id){t.currentSegment={fromStation:r,toStation:l,entryAngle:C.EAST,exitAngle:C.EAST,waypoints:[{x:r.vertexX,y:r.vertexY,type:"STATION"}]},t.totalLength=0;return}const c=Math.min(e,s),h=Math.max(e,s),u=i.stationIds[c],x=i.stationIds[h],o=this.gameState.stations.find(m=>m.id===u),f=this.gameState.stations.find(m=>m.id===x);let S=null;if(h+1<i.stationIds.length){const m=i.stationIds[h+1],T=this.gameState.stations.find(L=>L.id===m);T&&(S=E(f,T))}const p=_(o,f,S);e>s&&p.waypoints.reverse(),t.currentSegment=p,t.totalLength=this.calculateSegmentLength(p)}calculateSegmentLength(t){let i=0;const e=t.waypoints;for(let s=0;s<e.length-1;s++){const a=e[s],d=e[s+1],r=d.x-a.x,l=d.y-a.y;i+=Math.sqrt(r*r+l*l)}return i}updateMetroRenderer(t=!1){t?this.metroRenderer.renderStationLabels(this.gameState.stations):(this.metroRenderer.renderStations(this.gameState.stations),this.metroRenderer.renderLines(this.gameState.lines,this.gameState.stations)),this.metroRenderer.renderTrains(this.gameState.lines,this.gameState.stations)}setGameState(t){this.gameState=t,(!this.gameState.simulationTime||isNaN(this.gameState.simulationTime))&&(this.gameState.simulationTime=new Date("2025-01-01T08:00:00").getTime()),this.mapRenderer.renderMap(t.map),this.drawMapBackground(),this.updateMetroRenderer(!1);const i=new Date(this.gameState.simulationTime);this.clockLabel.text=this.formatDateTime(i)}drawMapBackground(){const t=this.gameState.map.width*M,i=this.gameState.map.height*M;this.mapBackground.clear(),this.mapBackground.rect(0,0,t,i),this.mapBackground.stroke({width:2,color:4473924})}resize(t,i){const e=t*.5;this.titleLabel.x=150,this.titleLabel.y=30,this.clockLabel.x=t-250,this.clockLabel.y=35;const s=i-80;this.stopButton.x=e-280,this.stopButton.y=s,this.speed1xButton.x=e+100,this.speed1xButton.y=s,this.speed2xButton.x=e+170,this.speed2xButton.y=s,this.speed4xButton.x=e+240,this.speed4xButton.y=s,this.speed12xButton.x=e+310,this.speed12xButton.y=s;const a=this.mapRenderer.getMapWidth(),d=this.mapRenderer.getMapHeight(),r=90,l=i-r-120,h=(t-40)/a,u=l/d,x=Math.min(1,h,u);this.mapContainer.scale.set(x),this.mapContainer.x=e-a*x/2,this.mapContainer.y=r}async show(){const t=[this.titleLabel,this.clockLabel,this.stopButton,this.speed1xButton,this.speed2xButton,this.speed4xButton,this.speed12xButton,this.mapContainer];for(const i of t)i.alpha=0;await V(t,{alpha:[0,1]},{duration:.3}).finished}update(){this.updateSimulation(A.shared)}onDestroy(){this.isRunning=!1}}export{O as MetroSimulationScreen};
