const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./StationDetailPopup-a0leatjT.js","./index-DLwTS2N6.js"])))=>i.map(i=>d[i]);
import{d as E,B as A,C as _,L as D,f as b,F as I,G as k,M as N,g as O,_ as S,s as V,h as $,D as R,i as W,j as X,k as L,l as Y,m as F,n as C,o as G,p as w}from"./index-DLwTS2N6.js";function z(s,e=0){return{id:`train-${Date.now()}-${Math.random().toString(36).substr(2,5)}`,lineId:s,state:"MOVING",dwellRemaining:0,currentStationIdx:e,targetStationIdx:e+1,progress:0,direction:1,currentSegment:null,totalLength:0,passengers:[],capacity:E}}function U(s,e,n){return{id:`p-${Date.now()}-${Math.random().toString(36).substr(2,5)}`,sourceStationId:s,destinationStationId:e,spawnTime:n,path:[],nextWaypointIndex:0,currentStationId:s}}function q(s,e,n,t){if(s===e)return[];const i=H(n,t),a=[],o=new Set;for(a.push({stationId:s,path:[s]}),o.add(s);a.length>0;){const r=a.shift(),{stationId:u,path:l}=r;if(u===e)return l;const h=i.get(u);if(h)for(const c of h.connections)o.has(c.targetStationId)||(o.add(c.targetStationId),a.push({stationId:c.targetStationId,path:[...l,c.targetStationId]}))}return null}function H(s,e){const n=new Map;for(const t of s)n.set(t.id,{stationId:t.id,connections:[]});for(const t of e)if(!(t.stationIds.length<2)){for(let i=0;i<t.stationIds.length-1;i++){const a=t.stationIds[i],o=t.stationIds[i+1],r=n.get(a),u=n.get(o);r&&u&&(r.connections.push({targetStationId:o,lineId:t.id}),u.connections.push({targetStationId:a,lineId:t.id}))}if(t.isLoop&&t.stationIds.length>2){const i=t.stationIds[t.stationIds.length-1],a=t.stationIds[0],o=n.get(i),r=n.get(a);o&&r&&(o.connections.push({targetStationId:a,lineId:t.id}),r.connections.push({targetStationId:i,lineId:t.id}))}}return n}const B=new Map;function y(s,e){if(B.has(s.id))return B.get(s.id);let n=0,t=0;const i=[{x:s.vertexX-1,y:s.vertexY-1},{x:s.vertexX,y:s.vertexY-1},{x:s.vertexX-1,y:s.vertexY},{x:s.vertexX,y:s.vertexY}],a=new Set,o=[];for(const d of i)P(d.x,d.y,e)&&(o.push({...d,dist:0}),a.add(`${d.x},${d.y}`));const r=s.vertexX-2,u=s.vertexX+1,l=s.vertexY-2,h=s.vertexY+1;a.clear(),o.length=0;for(const d of i)d.x>=r&&d.x<=u&&d.y>=l&&d.y<=h&&P(d.x,d.y,e)&&(o.push({...d,dist:0}),a.add(`${d.x},${d.y}`));let c=0;for(;c<o.length;){const d=o[c++],m=e.squares[d.y][d.x];n+=m.homeDensity,t+=m.officeDensity;const x=[{x:d.x-1,y:d.y},{x:d.x+1,y:d.y},{x:d.x,y:d.y-1},{x:d.x,y:d.y+1}];for(const p of x)p.x>=r&&p.x<=u&&p.y>=l&&p.y<=h&&!a.has(`${p.x},${p.y}`)&&P(p.x,p.y,e)&&(a.add(`${p.x},${p.y}`),o.push({...p,dist:d.dist+1}))}const g={residential:n,office:t};return B.set(s.id,g),g}function P(s,e,n){return s<0||s>=n.width||e<0||e>=n.height?!1:n.squares[e][s].type==="LAND"}function j(s,e){s.stations.length>0&&B.size===0&&s.stations.forEach(l=>y(l,s.map));const t=new Date(s.simulationTime).getHours();let i=!1,a=!1,o=1;t>=6&&t<10?(i=!0,o=3):t>=16&&t<20?(a=!0,o=3):(t>=22||t<5)&&(o=.1);const r=new Map;let u=0;for(const l of s.stations){const h=y(l,s.map);let c=1;i?c+=h.office*2:a?c+=h.residential*2:c+=h.residential+h.office,r.set(l.id,c),u+=c}for(const l of s.stations){const h=y(l,s.map);let c=0;i?c=h.residential:a?c=h.office:c=(h.residential+h.office)*.5;const g=c/(1e4*25),d=A*o*g*e/3600;Math.random()<d&&J(l,s,r,u)}}function J(s,e,n,t){const i=n.get(s.id)||0,a=t-i;if(a<=0)return;let o=Math.random()*a,r="";for(const h of e.stations){if(h.id===s.id)continue;const c=n.get(h.id)||0;if(o-=c,o<=0){r=h.id;break}}if(!r&&e.stations.length>1){const h=e.stations.find(c=>c.id!==s.id);h&&(r=h.id)}if(!r)return;const u=q(s.id,r,e.stations,e.lines);if(!u||u.length===0)return;const l=U(s.id,r,e.simulationTime);l.path=u,l.nextWaypointIndex=1,e.passengers.push(l),s.passengers.push(l)}function Q(s,e,n){const t=n.stationIds.indexOf(e);if(t===-1)return!1;const i=s.currentStationIdx;return s.direction===1?t>i:t<i}function Z(s,e,n){for(const t of n){const i=t.stationIds.indexOf(s),a=t.stationIds.indexOf(e);if(i!==-1&&a!==-1)return t.id}return null}function K(s,e,n){const t=n.lines.find(a=>a.id===e.lineId);if(!t)return;e.passengers||(e.passengers=[]);const i=s.passengers.filter(a=>a.currentStationId===s.id&&!a.currentTrainId);for(const a of i){if(e.passengers.length>=E)break;if(tt(a,e,t,n)){a.currentStationId=void 0,a.currentTrainId=e.id,e.passengers.push(a);const o=s.passengers.indexOf(a);o!==-1&&s.passengers.splice(o,1)}}}function tt(s,e,n,t){const i=s.path[s.nextWaypointIndex];if(!i)return!1;const a=s.currentStationId;return!a||Z(a,i,t.lines)!==n.id?!1:Q(e,i,n)}function et(s,e,n){if(!e.passengers){e.passengers=[];return}const t=[];for(const i of e.passengers)i.path[i.nextWaypointIndex]===s.id&&t.push(i);for(const i of t){const a=e.passengers.indexOf(i);a!==-1&&e.passengers.splice(a,1),i.currentTrainId=void 0,s.id===i.destinationStationId?nt(i,n):(i.currentStationId=s.id,i.nextWaypointIndex++,s.passengers.push(i))}}function nt(s,e){const n=e.passengers.indexOf(s);n!==-1&&e.passengers.splice(n,1);for(const t of e.stations){const i=t.passengers.indexOf(s);i!==-1&&(t.passengers.splice(i,1),console.warn(`Cleaned up completed passenger ${s.id} from station ${t.id}`))}s.currentStationId=void 0,s.currentTrainId=void 0}function it(s,e,n){et(e,s,n),K(e,s,n)}const T=G,st=T*2,at=T*4;class rt extends _{static assetBundles=["main"];titleLabel;clockLabel;stopButton;pauseToggleButton;speed1xButton;speed2xButton;speed4xButton;mapRenderer;metroRenderer;mapContainer;mapBackground;gameState;isRunning=!1;isPaused=!1;currentSpeed="1x";lastUpdateTime=0;constructor(){super(),this.titleLabel=new D({text:"Metro Simulation",style:{fontSize:36,fill:16777215}}),this.addChild(this.titleLabel),this.clockLabel=new D({text:this.formatDateTime(new Date(b)),style:{fontSize:24,fill:8965375,fontFamily:"monospace"}}),this.addChild(this.clockLabel),this.stopButton=new I({text:"Stop Simulation",width:160,height:50,fontSize:18,backgroundColor:15158332}),this.stopButton.onPress.connect(()=>this.stopSimulation()),this.addChild(this.stopButton),this.pauseToggleButton=new I({text:"Pause",width:100,height:50,fontSize:18,backgroundColor:15965202}),this.pauseToggleButton.onPress.connect(()=>this.togglePause()),this.addChild(this.pauseToggleButton),this.speed1xButton=new I({text:"1x",width:60,height:50,fontSize:18,backgroundColor:4886754}),this.speed1xButton.onPress.connect(()=>this.setSpeed("1x")),this.addChild(this.speed1xButton),this.speed2xButton=new I({text:"2x",width:60,height:50,fontSize:18,backgroundColor:5592405}),this.speed2xButton.onPress.connect(()=>this.setSpeed("2x")),this.addChild(this.speed2xButton),this.speed4xButton=new I({text:"4x",width:60,height:50,fontSize:18,backgroundColor:5592405}),this.speed4xButton.onPress.connect(()=>this.setSpeed("4x")),this.addChild(this.speed4xButton),this.mapContainer=new _,this.addChild(this.mapContainer),this.mapBackground=new k,this.mapContainer.addChild(this.mapBackground),this.mapRenderer=new N,this.mapContainer.addChild(this.mapRenderer),this.metroRenderer=new O,this.mapContainer.addChild(this.metroRenderer)}formatDateTime(e){if(!e||isNaN(e.getTime())){const r=new Date("2025-01-01T08:00:00");return this.formatDateTime(r)}const n=e.getDate().toString().padStart(2,"0"),t=(e.getMonth()+1).toString().padStart(2,"0"),i=e.getFullYear(),a=e.getHours().toString().padStart(2,"0"),o=e.getMinutes().toString().padStart(2,"0");return`${n}/${t}/${i} ${a}:${o}`}setSpeed(e){this.currentSpeed=e,e==="1x"?(this.speed1xButton.alpha=1,this.speed1xButton.defaultView.tint=4886754,this.speed2xButton.alpha=.7,this.speed2xButton.defaultView.tint=8947848,this.speed4xButton.alpha=.7,this.speed4xButton.defaultView.tint=8947848):e==="2x"?(this.speed1xButton.alpha=.7,this.speed1xButton.defaultView.tint=8947848,this.speed2xButton.alpha=1,this.speed2xButton.defaultView.tint=4886754,this.speed4xButton.alpha=.7,this.speed4xButton.defaultView.tint=8947848):e==="4x"&&(this.speed1xButton.alpha=.7,this.speed1xButton.defaultView.tint=8947848,this.speed2xButton.alpha=.7,this.speed2xButton.defaultView.tint=8947848,this.speed4xButton.alpha=1,this.speed4xButton.defaultView.tint=4886754)}async stopSimulation(){if(this.isRunning=!1,!this.gameState){console.warn("MetroSimulationScreen: gameState is undefined during stopSimulation");const{MetroBuildingScreen:i}=await S(async()=>{const{MetroBuildingScreen:o}=await import("./index-DLwTS2N6.js").then(r=>r.aN);return{MetroBuildingScreen:o}},[],import.meta.url),{engine:a}=await S(async()=>{const{engine:o}=await import("./index-DLwTS2N6.js").then(r=>r.aM);return{engine:o}},[],import.meta.url);await a().navigation.showScreen(i);return}V(this.gameState);const{MetroBuildingScreen:e}=await S(async()=>{const{MetroBuildingScreen:i}=await import("./index-DLwTS2N6.js").then(a=>a.aN);return{MetroBuildingScreen:i}},[],import.meta.url),{engine:n}=await S(async()=>{const{engine:i}=await import("./index-DLwTS2N6.js").then(a=>a.aM);return{engine:i}},[],import.meta.url);await n().navigation.showScreen(e);const t=n().navigation.currentScreen;t&&t.setGameState&&t.setGameState(this.gameState)}togglePause(){this.isPaused=!this.isPaused,this.isPaused?(this.pauseToggleButton.text="Resume",this.pauseToggleButton.defaultView.tint=2600544):(this.pauseToggleButton.text="Pause",this.pauseToggleButton.defaultView.tint=15965202)}updateSimulation=e=>{if(!this.isRunning)return;const n=performance.now();if(this.isPaused){this.lastUpdateTime=n;return}const t=(n-this.lastUpdateTime)/1e3;this.lastUpdateTime=n;let i,a;switch(this.currentSpeed){case"1x":i=T,a=1;break;case"2x":i=st,a=2;break;case"4x":i=at,a=4;break;default:i=T,a=1}const o=t*i;this.gameState.simulationTime+=o;const r=new Date(this.gameState.simulationTime);this.clockLabel.text=this.formatDateTime(r),j(this.gameState,t*i),this.updateTrains(t*a),this.updateMetroRenderer(!0)};startSimulation(){this.isRunning=!0,this.isPaused=!1,this.pauseToggleButton.text="Pause",this.pauseToggleButton.defaultView.tint=15965202,this.lastUpdateTime=performance.now(),this.initializeTrains(),this.setSpeed(this.currentSpeed)}initializeTrains(){for(const e of this.gameState.lines)if(!e.trains||e.trains.length===0){e.trains=[];const n=z(e.id,0);this.updateTrainPath(n,e),e.trains.push(n)}else for(const n of e.trains)n.passengers||(n.passengers=[]),n.currentSegment||this.updateTrainPath(n,e)}updateTrains(e){for(const n of this.gameState.lines)if(n.trains){for(const t of n.trains)if(t.state||(t.state="MOVING",t.dwellRemaining=0),!(!t.currentSegment&&(this.updateTrainPath(t,n),!t.currentSegment))){if(t.state==="STOPPED"){const i=C*e;if(t.dwellRemaining-=i,t.dwellRemaining<=0)t.state="MOVING",t.dwellRemaining=0;else continue}if(t.state==="MOVING"){const i=t.totalLength,a=t.progress*i,o=i-a;let r=1;if(a<w){const c=Math.max(.1,a/w);r=Math.min(r,c)}if(o<w){const c=Math.max(.1,o/w);r=Math.min(r,c)}const l=C*r*e,h=t.totalLength>0?l/t.totalLength:1;if(t.progress+=h,t.progress>=1){t.currentStationIdx=t.targetStationIdx,t.progress=0,t.state="STOPPED",t.dwellRemaining=$,n.isLoop?t.direction===1?t.targetStationIdx=(t.currentStationIdx+1)%n.stationIds.length:t.targetStationIdx=(t.currentStationIdx-1+n.stationIds.length)%n.stationIds.length:t.direction===1?t.currentStationIdx>=n.stationIds.length-1?(t.direction=-1,t.targetStationIdx=t.currentStationIdx-1):t.targetStationIdx=t.currentStationIdx+1:t.currentStationIdx<=0?(t.direction=1,t.targetStationIdx=t.currentStationIdx+1):t.targetStationIdx=t.currentStationIdx-1;const c=n.stationIds[t.currentStationIdx],g=this.gameState.stations.find(d=>d.id===c);g&&it(t,g,this.gameState),this.updateTrainPath(t,n)}}}}}updateTrainPath(e,n){const t=e.currentStationIdx,i=e.targetStationIdx,a=n.stationIds[t],o=n.stationIds[i],r=this.gameState.stations.find(f=>f.id===a),u=this.gameState.stations.find(f=>f.id===o);if(!r||!u)return;if(r.id===u.id){e.currentSegment={fromStation:r,toStation:u,entryAngle:R.EAST,exitAngle:R.EAST,waypoints:[{x:r.vertexX,y:r.vertexY,type:"STATION"}]},e.totalLength=0;return}const l=Math.min(t,i),h=Math.max(t,i),c=n.stationIds[l],g=n.stationIds[h],d=this.gameState.stations.find(f=>f.id===c),m=this.gameState.stations.find(f=>f.id===g);let x=null;if(h+1<n.stationIds.length){const f=n.stationIds[h+1],M=this.gameState.stations.find(v=>v.id===f);M&&(x=W(m,M))}const p=X(d,m,x);t>i&&p.waypoints.reverse(),e.currentSegment=p,e.totalLength=this.calculateSegmentLength(p)}calculateSegmentLength(e){let n=0;const t=e.waypoints;for(let i=0;i<t.length-1;i++){const a=t[i],o=t[i+1],r=o.x-a.x,u=o.y-a.y;n+=Math.sqrt(r*r+u*u)}return n}updateMetroRenderer(e=!1){e?this.metroRenderer.renderStationLabels(this.gameState.stations):(this.metroRenderer.renderStations(this.gameState.stations),this.metroRenderer.renderLines(this.gameState.lines,this.gameState.stations)),this.metroRenderer.renderTrains(this.gameState.lines,this.gameState.stations)}setGameState(e){this.gameState=e,(!this.gameState.simulationTime||isNaN(this.gameState.simulationTime))&&(this.gameState.simulationTime=new Date("2025-01-01T08:00:00").getTime()),this.mapRenderer.renderMap(e.map),this.drawMapBackground(),this.updateMetroRenderer(!1),this.metroRenderer.onStationClick=t=>{this.showStationDetails(t)};const n=new Date(this.gameState.simulationTime);this.clockLabel.text=this.formatDateTime(n)}drawMapBackground(){const e=this.gameState.map.width*L,n=this.gameState.map.height*L;this.mapBackground.clear(),this.mapBackground.rect(0,0,e,n),this.mapBackground.stroke({width:2,color:4473924})}async showStationDetails(e){const{StationDetailPopup:n,setStationForPopup:t}=await S(async()=>{const{StationDetailPopup:a,setStationForPopup:o}=await import("./StationDetailPopup-a0leatjT.js");return{StationDetailPopup:a,setStationForPopup:o}},__vite__mapDeps([0,1]),import.meta.url),{engine:i}=await S(async()=>{const{engine:a}=await import("./index-DLwTS2N6.js").then(o=>o.aM);return{engine:a}},[],import.meta.url);t(e,this.gameState.stations),i().navigation.presentPopup(n)}resize(e,n){const t=e*.5,i=30;this.titleLabel.anchor.set(0,.5),this.titleLabel.x=20,this.titleLabel.y=i,this.clockLabel.anchor.set(1,.5),this.clockLabel.x=e-20,this.clockLabel.y=i;const a=80;this.stopButton.x=20+this.stopButton.width/2,this.stopButton.y=a,this.pauseToggleButton.x=this.stopButton.x+this.stopButton.width/2+10+this.pauseToggleButton.width/2,this.pauseToggleButton.y=a;const o=10;let r=e-20-this.speed4xButton.width/2;this.speed4xButton.x=r,this.speed4xButton.y=a,r-=this.speed4xButton.width/2+o+this.speed2xButton.width/2,this.speed2xButton.x=r,this.speed2xButton.y=a,r-=this.speed2xButton.width/2+o+this.speed1xButton.width/2,this.speed1xButton.x=r,this.speed1xButton.y=a;const u=120,l=10,h=this.mapRenderer.getMapWidth(),c=this.mapRenderer.getMapHeight(),g=e-40,d=n-u-l,m=g/h,x=d/c,p=Math.min(1,m,x);this.mapContainer.scale.set(p),this.mapContainer.x=t-h*p/2,this.mapContainer.y=u}async show(){const e=[this.titleLabel,this.clockLabel,this.stopButton,this.pauseToggleButton,this.speed1xButton,this.speed2xButton,this.speed4xButton,this.mapContainer];for(const n of e)n.alpha=0;await Y(e,{alpha:1},{duration:.4,ease:"easeOut"})}update(){this.updateSimulation(F.shared)}onDestroy(){this.isRunning=!1}}export{rt as MetroSimulationScreen};
