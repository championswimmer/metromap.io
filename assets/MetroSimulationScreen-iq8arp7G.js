const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./StationDetailPopup-DEYOXkMC.js","./index-BkKjymOB.js"])))=>i.map(i=>d[i]);
import{d as C,f as P,B as E,C as D,L as M,g as b,F as I,G as A,M as k,h as $,_ as S,s as O,D as L,i as V,j as W,k as v,l as X,m as N,n as Y}from"./index-BkKjymOB.js";function z(i,t=0,n=C){return{id:`train-${Date.now()}-${Math.random().toString(36).substr(2,5)}`,lineId:i,currentStationIdx:t,targetStationIdx:t+1,progress:0,direction:1,speed:n,currentSegment:null,totalLength:0,passengers:[],capacity:P}}function F(i,t,n){return{id:`p-${Date.now()}-${Math.random().toString(36).substr(2,5)}`,sourceStationId:i,destinationStationId:t,spawnTime:n,path:[],nextWaypointIndex:0,currentStationId:i}}function G(i,t,n,e){if(i===t)return[];const s=q(n,e),a=[],o=new Set;for(a.push({stationId:i,path:[i]}),o.add(i);a.length>0;){const r=a.shift(),{stationId:h,path:l}=r;if(h===t)return l;const c=s.get(h);if(c)for(const u of c.connections)o.has(u.targetStationId)||(o.add(u.targetStationId),a.push({stationId:u.targetStationId,path:[...l,u.targetStationId]}))}return null}function q(i,t){const n=new Map;for(const e of i)n.set(e.id,{stationId:e.id,connections:[]});for(const e of t)if(!(e.stationIds.length<2)){for(let s=0;s<e.stationIds.length-1;s++){const a=e.stationIds[s],o=e.stationIds[s+1],r=n.get(a),h=n.get(o);r&&h&&(r.connections.push({targetStationId:o,lineId:e.id}),h.connections.push({targetStationId:a,lineId:e.id}))}if(e.isLoop&&e.stationIds.length>2){const s=e.stationIds[e.stationIds.length-1],a=e.stationIds[0],o=n.get(s),r=n.get(a);o&&r&&(o.connections.push({targetStationId:a,lineId:e.id}),r.connections.push({targetStationId:s,lineId:e.id}))}}return n}const w=new Map;function y(i,t){if(w.has(i.id))return w.get(i.id);let n=0,e=0;const s=[{x:i.vertexX-1,y:i.vertexY-1},{x:i.vertexX,y:i.vertexY-1},{x:i.vertexX-1,y:i.vertexY},{x:i.vertexX,y:i.vertexY}],a=new Set,o=[];for(const d of s)T(d.x,d.y,t)&&(o.push({...d,dist:0}),a.add(`${d.x},${d.y}`));const r=i.vertexX-2,h=i.vertexX+1,l=i.vertexY-2,c=i.vertexY+1;a.clear(),o.length=0;for(const d of s)d.x>=r&&d.x<=h&&d.y>=l&&d.y<=c&&T(d.x,d.y,t)&&(o.push({...d,dist:0}),a.add(`${d.x},${d.y}`));let u=0;for(;u<o.length;){const d=o[u++],m=t.squares[d.y][d.x];n+=m.homeDensity,e+=m.officeDensity;const x=[{x:d.x-1,y:d.y},{x:d.x+1,y:d.y},{x:d.x,y:d.y-1},{x:d.x,y:d.y+1}];for(const p of x)p.x>=r&&p.x<=h&&p.y>=l&&p.y<=c&&!a.has(`${p.x},${p.y}`)&&T(p.x,p.y,t)&&(a.add(`${p.x},${p.y}`),o.push({...p,dist:d.dist+1}))}const g={residential:n,office:e};return w.set(i.id,g),g}function T(i,t,n){return i<0||i>=n.width||t<0||t>=n.height?!1:n.squares[t][i].type==="LAND"}function H(i,t){i.stations.length>0&&w.size===0&&i.stations.forEach(l=>y(l,i.map));const e=new Date(i.simulationTime).getHours();let s=!1,a=!1,o=1;e>=6&&e<10?(s=!0,o=3):e>=16&&e<20?(a=!0,o=3):(e>=22||e<5)&&(o=.1);const r=new Map;let h=0;for(const l of i.stations){const c=y(l,i.map);let u=1;s?u+=c.office*2:a?u+=c.residential*2:u+=c.residential+c.office,r.set(l.id,u),h+=u}for(const l of i.stations){const c=y(l,i.map);let u=0;s?u=c.residential:a?u=c.office:u=(c.residential+c.office)*.5;const g=u/(1e4*25),d=E*o*g*t/3600;Math.random()<d&&U(l,i,r,h)}}function U(i,t,n,e){const s=n.get(i.id)||0,a=e-s;if(a<=0)return;let o=Math.random()*a,r="";for(const c of t.stations){if(c.id===i.id)continue;const u=n.get(c.id)||0;if(o-=u,o<=0){r=c.id;break}}if(!r&&t.stations.length>1){const c=t.stations.find(u=>u.id!==i.id);c&&(r=c.id)}if(!r)return;const h=G(i.id,r,t.stations,t.lines);if(!h||h.length===0)return;const l=F(i.id,r,t.simulationTime);l.path=h,l.nextWaypointIndex=1,t.passengers.push(l),i.passengers.push(l)}function K(i,t,n){const e=n.stationIds.indexOf(t);if(e===-1)return!1;const s=i.currentStationIdx;return i.direction===1?e>s:e<s}function j(i,t,n){for(const e of n){const s=e.stationIds.indexOf(i),a=e.stationIds.indexOf(t);if(s!==-1&&a!==-1)return e.id}return null}function J(i,t,n){const e=n.lines.find(a=>a.id===t.lineId);if(!e)return;t.passengers||(t.passengers=[]);const s=i.passengers.filter(a=>a.currentStationId===i.id&&!a.currentTrainId);for(const a of s){if(t.passengers.length>=P)break;if(Z(a,t,e,n)){a.currentStationId=void 0,a.currentTrainId=t.id,t.passengers.push(a);const o=i.passengers.indexOf(a);o!==-1&&i.passengers.splice(o,1)}}}function Z(i,t,n,e){const s=i.path[i.nextWaypointIndex];if(!s)return!1;const a=i.currentStationId;return!a||j(a,s,e.lines)!==n.id?!1:K(t,s,n)}function Q(i,t,n){if(!t.passengers){t.passengers=[];return}const e=[];for(const s of t.passengers)s.path[s.nextWaypointIndex]===i.id&&e.push(s);for(const s of e){const a=t.passengers.indexOf(s);a!==-1&&t.passengers.splice(a,1),s.currentTrainId=void 0,i.id===s.destinationStationId?tt(s,n):(s.currentStationId=i.id,s.nextWaypointIndex++,i.passengers.push(s))}}function tt(i,t){const n=t.passengers.indexOf(i);n!==-1&&t.passengers.splice(n,1);for(const e of t.stations){const s=e.passengers.indexOf(i);s!==-1&&(e.passengers.splice(s,1),console.warn(`Cleaned up completed passenger ${i.id} from station ${e.id}`))}i.currentStationId=void 0,i.currentTrainId=void 0}function et(i,t,n){Q(t,i,n),J(t,i,n)}const B=Y,nt=B*2,it=B*4;class at extends D{static assetBundles=["main"];titleLabel;clockLabel;stopButton;speed1xButton;speed2xButton;speed4xButton;mapRenderer;metroRenderer;mapContainer;mapBackground;gameState;isRunning=!1;currentSpeed="1x";lastUpdateTime=0;constructor(){super(),this.titleLabel=new M({text:"Metro Simulation",style:{fontSize:36,fill:16777215}}),this.addChild(this.titleLabel),this.clockLabel=new M({text:this.formatDateTime(new Date(b)),style:{fontSize:24,fill:8965375,fontFamily:"monospace"}}),this.addChild(this.clockLabel),this.stopButton=new I({text:"Stop Simulation",width:160,height:50,fontSize:18,backgroundColor:15158332}),this.stopButton.onPress.connect(()=>this.stopSimulation()),this.addChild(this.stopButton),this.speed1xButton=new I({text:"1x",width:60,height:50,fontSize:18,backgroundColor:4886754}),this.speed1xButton.onPress.connect(()=>this.setSpeed("1x")),this.addChild(this.speed1xButton),this.speed2xButton=new I({text:"2x",width:60,height:50,fontSize:18,backgroundColor:5592405}),this.speed2xButton.onPress.connect(()=>this.setSpeed("2x")),this.addChild(this.speed2xButton),this.speed4xButton=new I({text:"4x",width:60,height:50,fontSize:18,backgroundColor:5592405}),this.speed4xButton.onPress.connect(()=>this.setSpeed("4x")),this.addChild(this.speed4xButton),this.mapContainer=new D,this.addChild(this.mapContainer),this.mapBackground=new A,this.mapContainer.addChild(this.mapBackground),this.mapRenderer=new k,this.mapContainer.addChild(this.mapRenderer),this.metroRenderer=new $,this.mapContainer.addChild(this.metroRenderer)}formatDateTime(t){if(!t||isNaN(t.getTime())){const r=new Date("2025-01-01T08:00:00");return this.formatDateTime(r)}const n=t.getDate().toString().padStart(2,"0"),e=(t.getMonth()+1).toString().padStart(2,"0"),s=t.getFullYear(),a=t.getHours().toString().padStart(2,"0"),o=t.getMinutes().toString().padStart(2,"0");return`${n}/${e}/${s} ${a}:${o}`}setSpeed(t){this.currentSpeed=t,t==="1x"?(this.speed1xButton.alpha=1,this.speed1xButton.defaultView.tint=4886754,this.speed2xButton.alpha=.7,this.speed2xButton.defaultView.tint=8947848,this.speed4xButton.alpha=.7,this.speed4xButton.defaultView.tint=8947848):t==="2x"?(this.speed1xButton.alpha=.7,this.speed1xButton.defaultView.tint=8947848,this.speed2xButton.alpha=1,this.speed2xButton.defaultView.tint=4886754,this.speed4xButton.alpha=.7,this.speed4xButton.defaultView.tint=8947848):t==="4x"&&(this.speed1xButton.alpha=.7,this.speed1xButton.defaultView.tint=8947848,this.speed2xButton.alpha=.7,this.speed2xButton.defaultView.tint=8947848,this.speed4xButton.alpha=1,this.speed4xButton.defaultView.tint=4886754)}async stopSimulation(){if(this.isRunning=!1,!this.gameState){console.warn("MetroSimulationScreen: gameState is undefined during stopSimulation");const{MetroBuildingScreen:s}=await S(async()=>{const{MetroBuildingScreen:o}=await import("./index-BkKjymOB.js").then(r=>r.aL);return{MetroBuildingScreen:o}},[],import.meta.url),{engine:a}=await S(async()=>{const{engine:o}=await import("./index-BkKjymOB.js").then(r=>r.aK);return{engine:o}},[],import.meta.url);await a().navigation.showScreen(s);return}O(this.gameState);const{MetroBuildingScreen:t}=await S(async()=>{const{MetroBuildingScreen:s}=await import("./index-BkKjymOB.js").then(a=>a.aL);return{MetroBuildingScreen:s}},[],import.meta.url),{engine:n}=await S(async()=>{const{engine:s}=await import("./index-BkKjymOB.js").then(a=>a.aK);return{engine:s}},[],import.meta.url);await n().navigation.showScreen(t);const e=n().navigation.currentScreen;e&&e.setGameState&&e.setGameState(this.gameState)}updateSimulation=t=>{if(!this.isRunning)return;const n=performance.now(),e=(n-this.lastUpdateTime)/1e3;this.lastUpdateTime=n;let s,a;switch(this.currentSpeed){case"1x":s=B,a=1;break;case"2x":s=nt,a=2;break;case"4x":s=it,a=4;break;default:s=B,a=1}const o=e*s;this.gameState.simulationTime+=o;const r=new Date(this.gameState.simulationTime);this.clockLabel.text=this.formatDateTime(r),H(this.gameState,e*s),this.updateTrains(e*a),this.updateMetroRenderer(!0)};startSimulation(){this.isRunning=!0,this.lastUpdateTime=performance.now(),this.initializeTrains(),this.setSpeed(this.currentSpeed)}initializeTrains(){for(const t of this.gameState.lines)if(!t.trains||t.trains.length===0){t.trains=[];const n=z(t.id,0,1);this.updateTrainPath(n,t),t.trains.push(n)}else for(const n of t.trains)n.passengers||(n.passengers=[]),n.currentSegment||this.updateTrainPath(n,t)}updateTrains(t){for(const n of this.gameState.lines)if(n.trains)for(const e of n.trains){if(!e.currentSegment&&(this.updateTrainPath(e,n),!e.currentSegment))continue;const a=e.speed*t/e.totalLength;if(e.progress+=a,e.progress>=1){e.currentStationIdx=e.targetStationIdx,e.progress=0,n.isLoop?e.direction===1?e.targetStationIdx=(e.currentStationIdx+1)%n.stationIds.length:e.targetStationIdx=(e.currentStationIdx-1+n.stationIds.length)%n.stationIds.length:e.direction===1?e.currentStationIdx>=n.stationIds.length-1?(e.direction=-1,e.targetStationIdx=e.currentStationIdx-1):e.targetStationIdx=e.currentStationIdx+1:e.currentStationIdx<=0?(e.direction=1,e.targetStationIdx=e.currentStationIdx+1):e.targetStationIdx=e.currentStationIdx-1;const o=n.stationIds[e.currentStationIdx],r=this.gameState.stations.find(h=>h.id===o);r&&et(e,r,this.gameState),this.updateTrainPath(e,n)}}}updateTrainPath(t,n){const e=t.currentStationIdx,s=t.targetStationIdx,a=n.stationIds[e],o=n.stationIds[s],r=this.gameState.stations.find(f=>f.id===a),h=this.gameState.stations.find(f=>f.id===o);if(!r||!h)return;if(r.id===h.id){t.currentSegment={fromStation:r,toStation:h,entryAngle:L.EAST,exitAngle:L.EAST,waypoints:[{x:r.vertexX,y:r.vertexY,type:"STATION"}]},t.totalLength=0;return}const l=Math.min(e,s),c=Math.max(e,s),u=n.stationIds[l],g=n.stationIds[c],d=this.gameState.stations.find(f=>f.id===u),m=this.gameState.stations.find(f=>f.id===g);let x=null;if(c+1<n.stationIds.length){const f=n.stationIds[c+1],_=this.gameState.stations.find(R=>R.id===f);_&&(x=V(m,_))}const p=W(d,m,x);e>s&&p.waypoints.reverse(),t.currentSegment=p,t.totalLength=this.calculateSegmentLength(p)}calculateSegmentLength(t){let n=0;const e=t.waypoints;for(let s=0;s<e.length-1;s++){const a=e[s],o=e[s+1],r=o.x-a.x,h=o.y-a.y;n+=Math.sqrt(r*r+h*h)}return n}updateMetroRenderer(t=!1){t?this.metroRenderer.renderStationLabels(this.gameState.stations):(this.metroRenderer.renderStations(this.gameState.stations),this.metroRenderer.renderLines(this.gameState.lines,this.gameState.stations)),this.metroRenderer.renderTrains(this.gameState.lines,this.gameState.stations)}setGameState(t){this.gameState=t,(!this.gameState.simulationTime||isNaN(this.gameState.simulationTime))&&(this.gameState.simulationTime=new Date("2025-01-01T08:00:00").getTime()),this.mapRenderer.renderMap(t.map),this.drawMapBackground(),this.updateMetroRenderer(!1),this.metroRenderer.onStationClick=e=>{this.showStationDetails(e)};const n=new Date(this.gameState.simulationTime);this.clockLabel.text=this.formatDateTime(n)}drawMapBackground(){const t=this.gameState.map.width*v,n=this.gameState.map.height*v;this.mapBackground.clear(),this.mapBackground.rect(0,0,t,n),this.mapBackground.stroke({width:2,color:4473924})}async showStationDetails(t){const{StationDetailPopup:n,setStationForPopup:e}=await S(async()=>{const{StationDetailPopup:a,setStationForPopup:o}=await import("./StationDetailPopup-DEYOXkMC.js");return{StationDetailPopup:a,setStationForPopup:o}},__vite__mapDeps([0,1]),import.meta.url),{engine:s}=await S(async()=>{const{engine:a}=await import("./index-BkKjymOB.js").then(o=>o.aK);return{engine:a}},[],import.meta.url);e(t,this.gameState.stations),s().navigation.presentPopup(n)}resize(t,n){const e=t*.5,s=30;this.titleLabel.anchor.set(0,.5),this.titleLabel.x=20,this.titleLabel.y=s,this.clockLabel.anchor.set(1,.5),this.clockLabel.x=t-20,this.clockLabel.y=s;const a=80;this.stopButton.x=20+this.stopButton.width/2,this.stopButton.y=a;const o=10;let r=t-20-this.speed4xButton.width/2;this.speed4xButton.x=r,this.speed4xButton.y=a,r-=this.speed4xButton.width/2+o+this.speed2xButton.width/2,this.speed2xButton.x=r,this.speed2xButton.y=a,r-=this.speed2xButton.width/2+o+this.speed1xButton.width/2,this.speed1xButton.x=r,this.speed1xButton.y=a;const h=120,l=10,c=this.mapRenderer.getMapWidth(),u=this.mapRenderer.getMapHeight(),g=t-40,d=n-h-l,m=g/c,x=d/u,p=Math.min(1,m,x);this.mapContainer.scale.set(p),this.mapContainer.x=e-c*p/2,this.mapContainer.y=h}async show(){const t=[this.titleLabel,this.clockLabel,this.stopButton,this.speed1xButton,this.speed2xButton,this.speed4xButton,this.mapContainer];for(const n of t)n.alpha=0;await X(t,{alpha:1},{duration:.4,ease:"easeOut"})}update(){this.updateSimulation(N.shared)}onDestroy(){this.isRunning=!1}}export{at as MetroSimulationScreen};
